<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-Room Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

    <style>
        :root { --vh: 1vh; }

        body {
            background-color: #f2f3f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-x: hidden;
        }

        .container {
            max-width: 700px;
            margin: auto;
            padding: 15px;
        }

        /* Landing Page */
        #landing {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 50px;
        }

        #landing button {
            width: 200px;
            margin: 10px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Create / Join Room Forms */
        #createRoomForm, #joinRoomForm {
            display: none;
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            margin-top: 30px;
        }

        #createRoomForm input, #joinRoomForm input {
            border-radius: 10px;
            margin-bottom: 10px;
            padding: 10px;
            width: 100%;
            border: 1px solid #ccc;
        }

        /* Chat Container */
        #chatContainer {
            display: none;
            flex-direction: column;
            height: calc(var(--vh, 1vh) * 100);
        }

        #chatWrapper {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        #chat {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 15px;
            background-color: #FFF8DC;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        /* Messages */
        .message-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            max-width: 75%;
            word-break: break-word;
        }

        .message-container.self { align-self: flex-end; }
        .message-container.other { align-self: flex-start; }

        .sender-name {
            font-weight: bold;
            margin-bottom: 3px;
            padding: 2px 6px;
            border-radius: 8px;
            color: #FFA500;
            display: inline-block;
        }

        .message-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.2);
            color: black;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-container.other .message-bubble { background-color: #fff; }
        .message-container.self .message-bubble { background-color: #34B7F1; color: black; }

        .message-time {
            font-size: 0.7rem;
            color: #666;
            margin-top: 2px;
            text-align: right;
        }

        .message-tick {
            font-size: 0.7rem;
            margin-left: 5px;
        }

        #typingIndicator {
            font-style: italic;
            color: #666;
            margin: 5px 0;
        }

        /* Input Area */
        .input-group {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
            padding: 5px 0;
            background-color: #f2f3f5;
            align-items: center;
        }

        .input-group input.form-control {
            flex: 1;
            min-width: 0;
            border-radius: 25px;
            padding: 10px 15px;
            font-size: 1rem;
        }

        .input-group button {
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #emojiBtn { background: none; border: none; }
        #sendMessage { background-color: #007bff; color: white; border: none; transition: 0.2s; }
        #sendMessage:hover { background-color: #0056b3; }

        #emojiPicker {
            position: absolute;
            bottom: 60px;
            left: 5px;
            display: none;
            z-index: 20;
        }

        @media(max-width: 768px) {
            #chat { padding: 10px; }
            .input-group input.form-control { font-size: 15px; padding: 8px 12px; }
            #sendMessage { width: 40px; height: 40px; font-size: 15px; }
            .input-group button { width: 40px; height: 40px; }
        }
    </style>
</head>
<body>
<div class="container text-center">

    <!-- Landing Page -->
    <div id="landing">
        <h1>Real-Time Chat</h1>
        <button id="createRoomBtn" class="btn btn-success">Create Room</button>
        <button id="joinRoomBtn" class="btn btn-primary">Join Room</button>
    </div>

    <!-- Create Room Form -->
    <div id="createRoomForm">
        <input id="roomNameInput" type="text" class="form-control" placeholder="Room name">
        <input id="roomPasswordInput" type="text" class="form-control" placeholder="Room password (optional)">
        <input id="userNameCreate" type="text" class="form-control" placeholder="Your name">
        <button id="createRoomSubmit" class="btn btn-success w-100">Create Room</button>
    </div>

    <!-- Join Room Form -->
    <div id="joinRoomForm">
        <input id="roomCodeInput" type="text" class="form-control" placeholder="Enter room code">
        <input id="joinRoomPassword" type="text" class="form-control" placeholder="Password (if any)">
        <input id="userNameJoin" type="text" class="form-control" placeholder="Your name">
        <button id="joinRoomSubmit" class="btn btn-primary w-100">Join Room</button>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer">
        <input type="hidden" id="senderInput">
        <h3 id="roomTitle"></h3>
        <div class="room-info" id="roomCodeDisplay"></div>
        <div><strong>Online Users:</strong> <span id="onlineUsers"></span></div>

        <div id="chatWrapper">
            <div id="chat">
                <div id="typingIndicator"></div>
            </div>
            <div class="input-group mb-3">
                <button id="emojiBtn">ðŸ˜Š</button>
                <input id="messageInput" type="text" class="form-control" placeholder="Type a message..."/>
                <button id="sendMessage">Send</button>
            </div>
        </div>
        <emoji-picker id="emojiPicker"></emoji-picker>
    </div>
</div>

<!-- Room Code Modal -->
<div class="modal fade" id="roomCodeModal" tabindex="-1" aria-labelledby="roomCodeLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Room Created</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Room Code: <span id="modalRoomCode" style="font-weight:bold;"></span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="copyRoomCodeBtn">Copy Code</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function(){

        function adjustVh() { document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); }
        window.addEventListener('resize', adjustVh);
        adjustVh();

        const emojiBtn = document.getElementById("emojiBtn");
        const emojiPicker = document.getElementById("emojiPicker");
        const messageInput = document.getElementById("messageInput");
        const senderInput = document.getElementById("senderInput");

        let stompClient = null;
        let roomId = null;
        let typingUsers = new Set();
        let typingTimeouts = {};
        let userColors = {};
        const colors = ["#f28b82","#fbbc04","#34b7f1","#a7ffeb","#fdcfe8","#cfd9df","#cbf0f8"];

        function getUserColor(username){
            if(!userColors[username]){ userColors[username]=colors[Math.floor(Math.random()*colors.length)]; }
            return userColors[username];
        }

        function updateTypingIndicator(){
            const indicator = document.getElementById('typingIndicator');
            indicator.textContent = typingUsers.size===0?'':Array.from(typingUsers).join(', ')+' is typing...';
            const chat = document.getElementById('chat');
            chat.scrollTop = chat.scrollHeight;
        }

        function showMessage(message){
            const chat = document.getElementById('chat');
            const container = document.createElement('div');
            const self = message.sender === senderInput.value;
            container.className = "message-container "+(self?'self':'other');

            const senderDiv = document.createElement('div');
            senderDiv.className = "sender-name";
            senderDiv.textContent = message.sender;

            const bubble = document.createElement('div');
            bubble.className = "message-bubble";
            bubble.textContent = message.content;

            const timeDiv = document.createElement('div');
            timeDiv.className = "message-time";
            const date = new Date(message.timestamp);
            timeDiv.textContent = date.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

            const tick = document.createElement('span');
            tick.className = "message-tick";
            tick.innerHTML = self ? (message.seenByAll ? "âœ”âœ”" : "âœ”") : "";
            timeDiv.appendChild(tick);

            container.appendChild(senderDiv);
            container.appendChild(bubble);
            container.appendChild(timeDiv);

            chat.insertBefore(container, document.getElementById('typingIndicator'));
            chat.scrollTop = chat.scrollHeight;
        }

        function connect(userName){
            const socket = new SockJS('/chat');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, frame=>{
                console.log('Connected: '+frame);
                stompClient.subscribe(`/topic/${roomId}`, msg=>{ showMessage(JSON.parse(msg.body)); });
                stompClient.subscribe(`/topic/typing/${roomId}`, msg=>{
                    const data = JSON.parse(msg.body);
                    if(data.sender && data.sender !== senderInput.value){
                        typingUsers.add(data.sender);
                        if(typingTimeouts[data.sender]) clearTimeout(typingTimeouts[data.sender]);
                        typingTimeouts[data.sender]=setTimeout(()=>{ typingUsers.delete(data.sender); updateTypingIndicator(); },1500);
                        updateTypingIndicator();
                    }
                });
            });
        }

        function sendMessage(){
            const sender = senderInput.value;
            const content = messageInput.value;
            if(sender && content && stompClient){
                stompClient.send(`/app/sendMessage/${roomId}`, {}, JSON.stringify({sender, content, timestamp: new Date(), seenByAll: false}));
                messageInput.value='';
            }
        }

        emojiBtn.addEventListener("click", ()=>{ emojiPicker.style.display = emojiPicker.style.display==="none" ? "block" : "none"; });
        emojiPicker.addEventListener("emoji-click", e=>{ messageInput.value += e.detail.unicode; emojiPicker.style.display="none"; messageInput.focus(); });
        document.addEventListener("click", e=>{ if(!emojiPicker.contains(e.target) && e.target!==emojiBtn) emojiPicker.style.display="none"; });

        document.getElementById('sendMessage').onclick = sendMessage;
        messageInput.addEventListener('keypress', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }});
        messageInput.addEventListener('input', ()=>{ if(!stompClient) return; stompClient.send(`/app/typing/${roomId}`, {}, JSON.stringify({sender:senderInput.value})); });

        document.getElementById('createRoomBtn').onclick = ()=>{ document.getElementById('landing').style.display='none'; document.getElementById('createRoomForm').style.display='block'; }
        document.getElementById('joinRoomBtn').onclick = ()=>{ document.getElementById('landing').style.display='none'; document.getElementById('joinRoomForm').style.display='block'; }

        document.getElementById('createRoomSubmit').onclick=async()=>{
            const roomName = document.getElementById('roomNameInput').value;
            const roomPassword = document.getElementById('roomPasswordInput').value;
            const userName = document.getElementById('userNameCreate').value;
            if(!roomName||!userName){ alert("Enter room name and your name"); return; }
            const res = await fetch(`/createRoom?roomName=${roomName}&password=${roomPassword||""}`, {method:"POST"});
            roomId = await res.text();
            senderInput.value = userName;
            enterChat(roomName, roomId, userName);
            document.getElementById('modalRoomCode').textContent = roomId;
            const modal = new bootstrap.Modal(document.getElementById('roomCodeModal'));
            modal.show();
            document.getElementById('copyRoomCodeBtn').onclick = ()=>{ navigator.clipboard.writeText(roomId); const btn=document.getElementById('copyRoomCodeBtn'); const original=btn.textContent; btn.textContent="Copied!"; setTimeout(()=>{btn.textContent=original;},1500); };
        }

        document.getElementById('joinRoomSubmit').onclick=async()=>{
            roomId=document.getElementById('roomCodeInput').value;
            const password=document.getElementById('joinRoomPassword').value;
            const userName=document.getElementById('userNameJoin').value;
            if(!roomId||!userName){ alert("Enter room code and your name"); return; }
            const res=await fetch(`/joinRoom?roomId=${roomId}&password=${password||""}&userName=${userName}`,{method:"POST"});
            const data=await res.json();
            if(data.success==="true"){ senderInput.value=userName; enterChat(data.roomName, roomId, userName); }
            else { alert("Invalid code or password"); }
        }

        function enterChat(roomName, code, userName){
            document.getElementById('createRoomForm').style.display='none';
            document.getElementById('joinRoomForm').style.display='none';
            document.getElementById('chatContainer').style.display='flex';
            document.getElementById('roomTitle').innerText = roomName;
            document.getElementById('roomCodeDisplay').innerText = `Room code: ${code}`;
            connect(userName);
        }

    });
</script>
</body>
</html>
