<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-Room Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            background-color: #f2f3f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin:0; padding:0;
        }
        .container { max-width: 700px; margin:auto; padding:15px; }

        /* Landing */
        #landing {
            display:flex; flex-direction:column; align-items:center; justify-content:center; margin-top:50px;
        }
        #landing button {
            width:200px; margin:10px; font-weight:bold; font-size:1.1rem;
        }

        /* Forms */
        #createRoomForm, #joinRoomForm {
            display:none;
            background:#fff; padding:20px; border-radius:15px; box-shadow:0 2px 10px rgba(0,0,0,0.2); margin-top:30px;
        }
        #createRoomForm input, #joinRoomForm input {
            border-radius:10px; margin-bottom:10px; padding:10px;
        }

        /* Chat Container */
        #chatContainer {
            display:none; flex-direction:column; height:80vh; margin-top:20px;
        }
       #chat {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-color: #FFF8DC; /* Cream color */
    border-radius: 15px;
    display: flex;
    flex-direction: column;
}

        /* Messages */
        .message-container {
            display:flex; flex-direction:column; margin-bottom:10px; max-width:75%;
        }
        .message-container.self { align-self:flex-end; }
        .message-container.other { align-self:flex-start; }
        .sender-name {
    font-weight:bold;
    margin-bottom:3px;
    padding:2px 6px;
    border-radius:8px;
    color: #FFA500; /* fixed orange color */
    display:inline-block;
    width:auto;
}

        .message-bubble {
            padding:8px 12px; border-radius:15px; word-wrap:break-word;
            box-shadow:0 1px 1px rgba(0,0,0,0.2); color:black;
        }
        .message-container.other .message-bubble { background-color:#fff; }
        .message-container.self .message-bubble { background-color:#34B7F1; color:black; }

        #typingIndicator { font-style:italic; color:#666; margin-top:5px; }
        .room-info, #onlineUsers { font-size:0.9rem; color:#555; margin-bottom:5px; }

        .input-group { margin-top:5px; }
        input.form-control { border-radius:10px; }

        @media(max-width:768px){
            #chat { height:60vh; padding:15px; }
            .input-group { flex-direction:column; }
            .input-group button { width:100%; margin-top:5px; }
        }
    </style>
</head>
<body>

<div class="container text-center">

    <!-- Landing Page -->
    <div id="landing">
        <h1>Real-Time Chat</h1>
        <button id="createRoomBtn" class="btn btn-success">Create Room</button>
        <button id="joinRoomBtn" class="btn btn-primary">Join Room</button>
    </div>

    <!-- Create Room Form -->
    <div id="createRoomForm">
        <input id="roomNameInput" type="text" class="form-control" placeholder="Room name">
        <input id="roomPasswordInput" type="text" class="form-control" placeholder="Room password (optional)">
        <input id="userNameCreate" type="text" class="form-control" placeholder="Your name">
        <button id="createRoomSubmit" class="btn btn-success w-100">Create Room</button>
    </div>

    <!-- Join Room Form -->
    <div id="joinRoomForm">
        <input id="roomCodeInput" type="text" class="form-control" placeholder="Enter room code">
        <input id="joinRoomPassword" type="text" class="form-control" placeholder="Password (if any)">
        <input id="userNameJoin" type="text" class="form-control" placeholder="Your name">
        <button id="joinRoomSubmit" class="btn btn-primary w-100">Join Room</button>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer">
        <h3 id="roomTitle"></h3>
        <div class="room-info" id="roomCodeDisplay"></div>
        <div><strong>Online Users:</strong> <span id="onlineUsers"></span></div>
        <div id="chat">
            <div id="typingIndicator"></div>
        </div>
        <input id="senderInput" type="text" class="form-control mb-2" placeholder="Your name..." readonly>
        <div class="input-group mb-3">
            <input id="messageInput" type="text" class="form-control" placeholder="Type a message..."/>
            <button id="sendMessage" class="btn btn-primary">Send</button>
        </div>
    </div>

</div>

<!-- Room Code Modal -->
<div class="modal fade" id="roomCodeModal" tabindex="-1" aria-labelledby="roomCodeLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Room Created</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Room Code: <span id="modalRoomCode" style="font-weight:bold;"></span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="copyRoomCodeBtn">Copy Code</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {

        let stompClient = null;
        let roomId = null;
        let typingUsers = new Set();
        let typingTimeouts = {};
        let userColors = {};
        const colors = ["#f28b82","#fbbc04","#34b7f1","#a7ffeb","#fdcfe8","#cfd9df","#cbf0f8"];

        function getUserColor(username){
            if(!userColors[username]){
                userColors[username]=colors[Math.floor(Math.random()*colors.length)];
            }
            return userColors[username];
        }

        function updateTypingIndicator(){
            const indicator = document.getElementById('typingIndicator');
            indicator.textContent = typingUsers.size===0?'':Array.from(typingUsers).join(', ')+' is typing...';
            document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;
        }

        function showMessage(message){
            const chat = document.getElementById('chat');
            const container = document.createElement('div');
            const self = message.sender===document.getElementById('senderInput').value;
            container.className="message-container "+(self?'self':'other');

            const senderDiv=document.createElement('div');
            senderDiv.className="sender-name";
            senderDiv.textContent=message.sender;
            const bubble=document.createElement('div');
            bubble.className="message-bubble";
            bubble.textContent=message.content;

            container.appendChild(senderDiv);
            container.appendChild(bubble);
            chat.insertBefore(container,document.getElementById('typingIndicator'));
            chat.scrollTop=chat.scrollHeight;
        }

        function connect(userName){
            const socket=new SockJS('/chat');
            stompClient=Stomp.over(socket);
            stompClient.connect({},frame=>{
                console.log('Connected: '+frame);
                stompClient.subscribe(`/topic/${roomId}`,msg=>{ showMessage(JSON.parse(msg.body)); });
                stompClient.subscribe(`/topic/typing/${roomId}`,msg=>{
                    const data=JSON.parse(msg.body);
                    if(data.sender && data.sender!==document.getElementById('senderInput').value){
                        typingUsers.add(data.sender);
                        if(typingTimeouts[data.sender]) clearTimeout(typingTimeouts[data.sender]);
                        typingTimeouts[data.sender]=setTimeout(()=>{ typingUsers.delete(data.sender); updateTypingIndicator(); },1500);
                        updateTypingIndicator();
                    }
                });
            });
        }

        function sendMessage(){
            const sender=document.getElementById('senderInput').value;
            const content=document.getElementById('messageInput').value;
            if(sender && content && stompClient){
                stompClient.send(`/app/sendMessage/${roomId}`,{},JSON.stringify({sender,content,timestamp:new Date()}));
                document.getElementById('messageInput').value='';
            }
        }

        // Event listeners
        document.getElementById('sendMessage').onclick = sendMessage;
        document.getElementById('messageInput').addEventListener('keypress',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); } });
        document.getElementById('messageInput').addEventListener('input',()=>{ if(!stompClient) return; stompClient.send(`/app/typing/${roomId}`,{},JSON.stringify({sender:document.getElementById('senderInput').value})); });

        // Landing buttons
        document.getElementById('createRoomBtn').onclick = ()=>{
            document.getElementById('landing').style.display='none';
            document.getElementById('createRoomForm').style.display='block';
        }
        document.getElementById('joinRoomBtn').onclick = ()=>{
            document.getElementById('landing').style.display='none';
            document.getElementById('joinRoomForm').style.display='block';
        }

        // Create Room
        document.getElementById('createRoomSubmit').onclick=async()=>{
            const roomName=document.getElementById('roomNameInput').value;
            const roomPassword=document.getElementById('roomPasswordInput').value;
            const userName=document.getElementById('userNameCreate').value;
            if(!roomName||!userName){ alert("Enter room name and your name"); return; }
            const res=await fetch(`/createRoom?roomName=${roomName}&password=${roomPassword||""}`,{method:"POST"});
            roomId=await res.text();
            document.getElementById('senderInput').value=userName;
            enterChat(roomName,roomId,userName);

            // Show modal with copy button (no alert popup)
            document.getElementById('modalRoomCode').textContent=roomId;
            const modal = new bootstrap.Modal(document.getElementById('roomCodeModal'));
            modal.show();
            document.getElementById('copyRoomCodeBtn').onclick = () => {
                navigator.clipboard.writeText(roomId);
                const btn = document.getElementById('copyRoomCodeBtn');
                const originalText = btn.textContent;
                btn.textContent = "Copied!";
                setTimeout(()=>{ btn.textContent = originalText; },1500);
            };
        }

        // Join Room
        document.getElementById('joinRoomSubmit').onclick=async()=>{
            roomId=document.getElementById('roomCodeInput').value;
            const password=document.getElementById('joinRoomPassword').value;
            const userName=document.getElementById('userNameJoin').value;
            if(!roomId||!userName){ alert("Enter room code and your name"); return; }
            const res=await fetch(`/joinRoom?roomId=${roomId}&password=${password||""}&userName=${userName}`,{method:"POST"});
            const data=await res.json();
            if(data.success==="true"){
                document.getElementById('senderInput').value=userName;
                enterChat(data.roomName,roomId,userName);
            } else { alert("Invalid code or password"); }
        }

        function enterChat(roomName,code,userName){
            document.getElementById('createRoomForm').style.display='none';
            document.getElementById('joinRoomForm').style.display='none';
            document.getElementById('chatContainer').style.display='flex';
            document.getElementById('roomTitle').innerText=roomName;
            document.getElementById('roomCodeDisplay').innerText=`Room code: ${code}`;
            connect(userName);
        }

    });
</script>


</body>
</html>
